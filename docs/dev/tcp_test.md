太好了！现在所有的测试都应该能够正常通过了。让我总结一下我们所做的所有修改和解决的问题：

## 问题解决总结

### 1. TCPServer 测试问题
**问题**: 测试会阻塞无法完成
**解决方案**:
- 增强了服务器停止逻辑，防止在服务器停止后继续接受新连接
- 改进了TCPSession的错误处理，确保所有错误情况都能正确关闭会话
- 优化了测试代码中的资源清理顺序和线程管理

### 2. TCPSession 测试问题
**问题**: "Bad file descriptor" 异常
**解决方案**:
- 修改了TCPSession构造函数，只在socket已连接的情况下才尝试获取remote_endpoint
- 添加了异常处理，防止获取remote_endpoint时出现错误
- 改进了测试代码，创建实际的连接对用于测试

### 3. 消息发送测试问题
**问题**: 消息发送后服务器无法接收
**解决方案**:
- 修正了消息格式，使用8字节长度前缀匹配TCPSession的期望格式
- 使用std::promise/std::future机制同步消息接收确认
- 增加了适当的等待时间和超时控制

## 主要技术改进

### 服务器端改进
1. **增强的停止逻辑**:
   - 在[handle_accept](file:///home/myself/workspace/MyChat/common/network/tcp_server.hpp#L77-L77)方法中添加了对服务器停止状态的检查
   - 确保服务器停止后不会继续接受新连接

2. **完善的错误处理**:
   - 确保所有错误情况都能触发[close()](file:///home/myself/workspace/MyChat/common/network/tcp_session.hpp#L56-L56)方法调用
   - 添加了详细的日志记录帮助诊断问题

### 客户端测试改进
1. **资源管理**:
   - 正确初始化和清理io_context相关资源
   - 改进了线程管理和资源清理顺序

2. **异步操作同步**:
   - 使用std::promise/std::future机制确保异步操作完成
   - 增加了适当的等待时间和超时控制

### 消息协议匹配
- 修正了客户端发送的消息格式，确保与服务器端TCPSession期望的格式一致
- 使用正确的字节序转换函数

## 测试稳定性增强

1. **增加日志输出**:
   - 添加了详细的日志帮助跟踪测试执行过程
   - 便于问题诊断和调试

2. **超时控制**:
   - 为所有异步操作设置合理的超时时间
   - 防止测试在异常情况下无限等待

3. **资源隔离**:
   - 确保测试之间不会相互影响
   - 正确管理单例资源的生命周期

现在所有的测试都应该能够稳定通过了。这些修改不仅解决了当前的问题，还提高了整个网络模块的稳定性和可测试性。