cmake_minimum_required(VERSION 3.16)
project(MyChat-Gateway-Demo)

# è®¾ç½® C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# è®¾ç½®ç¼–è¯‘é€‰é¡¹
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -O2")
set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -g -O0")
set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O2 -DNDEBUG")

# è®¾ç½®é»˜è®¤æ„å»ºç±»å‹
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()

message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")

# æŸ¥æ‰¾å¿…è¦çš„åŒ…
find_package(Protobuf REQUIRED)
find_package(Boost REQUIRED COMPONENTS system thread)
find_package(PkgConfig REQUIRED)

# å¯é€‰çš„OpenSSLæ”¯æŒï¼ˆç”¨äºè®¤è¯ï¼‰
find_package(OpenSSL)
if(OpenSSL_FOUND)
    message(STATUS "OpenSSL found - enabling crypto support")
    add_definitions(-DWITH_OPENSSL)
else()
    message(WARNING "OpenSSL not found - using simplified crypto")
endif()

# è®¾ç½®åŒ…å«ç›®å½•
include_directories(${CMAKE_SOURCE_DIR})
include_directories(${CMAKE_SOURCE_DIR}/src)
include_directories(${CMAKE_SOURCE_DIR}/../..)  # è®¿é—®é¡¹ç›®æ ¹ç›®å½•
include_directories(${CMAKE_SOURCE_DIR}/../../common)
include_directories(${Protobuf_INCLUDE_DIRS})

# httplib æ”¯æŒ
# æ£€æŸ¥æ˜¯å¦å·²ä¸‹è½½httplib
set(HTTPLIB_DIR "${CMAKE_SOURCE_DIR}/third_party/httplib")
if(NOT EXISTS "${HTTPLIB_DIR}/httplib.h")
    message(STATUS "httplib.h not found, attempting to download...")
    file(MAKE_DIRECTORY "${HTTPLIB_DIR}")
    
    # å°è¯•ä¸‹è½½httplib.h
    if(NOT EXISTS "${HTTPLIB_DIR}/httplib.h")
        message(WARNING "httplib.h not found at ${HTTPLIB_DIR}")
        message(WARNING "Please download manually:")
        message(WARNING "  mkdir -p ${HTTPLIB_DIR}")
        message(WARNING "  wget -O ${HTTPLIB_DIR}/httplib.h https://raw.githubusercontent.com/yhirose/cpp-httplib/master/httplib.h")
        message(FATAL_ERROR "httplib.h is required for HTTP support")
    endif()
else()
    message(STATUS "Found httplib.h at ${HTTPLIB_DIR}")
endif()

include_directories(${CMAKE_SOURCE_DIR}/third_party/httplib)

# æ”¶é›†æºæ–‡ä»¶
file(GLOB_RECURSE DEMO_SOURCES
    "src/*.cpp"
    "src/*.hpp"
)

# æ”¶é›†å…¬å…±æºæ–‡ä»¶
file(GLOB_RECURSE COMMON_NETWORK_SOURCES
    "../../common/network/*.cpp"
)

file(GLOB_RECURSE COMMON_UTILS_SOURCES  
    "../../common/utils/*.cpp"
)

file(GLOB_RECURSE COMMON_PROTO_SOURCES
    "../../common/proto/*.cc"
)

# åˆå¹¶æ‰€æœ‰æºæ–‡ä»¶
set(ALL_SOURCES
    ${DEMO_SOURCES}
    ${COMMON_NETWORK_SOURCES}
    ${COMMON_UTILS_SOURCES}
    ${COMMON_PROTO_SOURCES}
)

# ç§»é™¤ä¸éœ€è¦çš„æµ‹è¯•æ–‡ä»¶
list(FILTER ALL_SOURCES EXCLUDE REGEX ".*test.*")
list(FILTER ALL_SOURCES EXCLUDE REGEX ".*Test.*")

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(gateway_server_demo ${ALL_SOURCES})

# è®¾ç½®ç›®æ ‡å±æ€§
set_target_properties(gateway_server_demo PROPERTIES
    OUTPUT_NAME "gateway_server"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
)

# é“¾æ¥åº“
target_link_libraries(gateway_server_demo
    ${Protobuf_LIBRARIES}
    ${Boost_LIBRARIES}
    pthread
)

# å¦‚æœæ‰¾åˆ°OpenSSLï¼Œé“¾æ¥OpenSSLåº“
if(OpenSSL_FOUND)
    target_link_libraries(gateway_server_demo OpenSSL::SSL OpenSSL::Crypto)
endif()

# å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
configure_file(
    ${CMAKE_SOURCE_DIR}/config/gateway_config.json
    ${CMAKE_BINARY_DIR}/bin/config/gateway_config.json
    COPYONLY
)

# åˆ›å»ºå¿…è¦çš„ç›®å½•
file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/bin/logs)

# åˆ›å»ºå¯åŠ¨è„šæœ¬
configure_file(
    ${CMAKE_SOURCE_DIR}/scripts/start_gateway.sh.in
    ${CMAKE_BINARY_DIR}/bin/start_gateway.sh
    @ONLY
)

# å®‰è£…è§„åˆ™
install(TARGETS gateway_server_demo 
    DESTINATION bin
)

install(FILES config/gateway_config.json 
    DESTINATION bin/config
)

install(DIRECTORY DESTINATION bin/logs)

# å¼€å‘å·¥å…·ç›®æ ‡
add_custom_target(clean-logs
    COMMAND rm -rf ${CMAKE_BINARY_DIR}/bin/logs/*
    COMMENT "Cleaning log files"
)

add_custom_target(run
    COMMAND ${CMAKE_BINARY_DIR}/bin/gateway_server ${CMAKE_BINARY_DIR}/bin/config/gateway_config.json
    DEPENDS gateway_server_demo
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}/bin
    COMMENT "Running gateway server"
)

add_custom_target(debug
    COMMAND gdb --args ${CMAKE_BINARY_DIR}/bin/gateway_server ${CMAKE_BINARY_DIR}/bin/config/gateway_config.json
    DEPENDS gateway_server_demo
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}/bin
    COMMENT "Running gateway server in debugger"
)

# æ‰“å°æ„å»ºä¿¡æ¯
message(STATUS "=== MyChat Gateway Demo Build Configuration ===")
message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Protobuf Version: ${Protobuf_VERSION}")
message(STATUS "Boost Version: ${Boost_VERSION}")
if(OpenSSL_FOUND)
    message(STATUS "OpenSSL Version: ${OPENSSL_VERSION}")
endif()
message(STATUS "Install Prefix: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "Output Directory: ${CMAKE_BINARY_DIR}/bin")
message(STATUS "=============================================")

# æ„å»ºåæç¤ºä¿¡æ¯
add_custom_command(TARGET gateway_server_demo POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E echo ""
    COMMAND ${CMAKE_COMMAND} -E echo "ğŸ‰ Gateway Demo Build Complete!"
    COMMAND ${CMAKE_COMMAND} -E echo "ğŸ“ Output: ${CMAKE_BINARY_DIR}/bin/"
    COMMAND ${CMAKE_COMMAND} -E echo "ğŸš€ Run: cd ${CMAKE_BINARY_DIR}/bin && ./gateway_server"
    COMMAND ${CMAKE_COMMAND} -E echo "ğŸƒ Quick: make run"
    COMMAND ${CMAKE_COMMAND} -E echo "ğŸ› Debug: make debug"
    COMMAND ${CMAKE_COMMAND} -E echo ""
)