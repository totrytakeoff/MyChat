#!/bin/bash

# MyChat Gateway Demo启动脚本
# 自动生成，请勿直接编辑

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
GATEWAY_BIN="$SCRIPT_DIR/gateway_server"
CONFIG_FILE="$SCRIPT_DIR/config/gateway_config.json"

echo "=========================================="
echo "   MyChat Gateway Demo - Startup Script"
echo "=========================================="
echo "Binary: $GATEWAY_BIN"
echo "Config: $CONFIG_FILE"
echo "Working Directory: $SCRIPT_DIR"
echo ""

# 检查依赖文件
if [ ! -f "$GATEWAY_BIN" ]; then
    echo "❌ Gateway binary not found: $GATEWAY_BIN"
    exit 1
fi

if [ ! -f "$CONFIG_FILE" ]; then
    echo "❌ Configuration file not found: $CONFIG_FILE"
    exit 1
fi

# 创建日志目录
mkdir -p "$SCRIPT_DIR/logs"

# 检查端口是否被占用
check_port() {
    local port=$1
    local service=$2
    
    if netstat -tuln 2>/dev/null | grep -q ":$port "; then
        echo "⚠️  Warning: Port $port ($service) appears to be in use"
        echo "   You may see binding errors when starting the gateway"
        return 1
    fi
    return 0
}

echo "Checking ports..."
check_port 8080 "HTTP"
check_port 8081 "WebSocket"

echo ""
echo "Starting Gateway Server..."
echo "Press Ctrl+C to stop"
echo ""

# 启动网关服务器
cd "$SCRIPT_DIR"
exec "$GATEWAY_BIN" "$CONFIG_FILE"